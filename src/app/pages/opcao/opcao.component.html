<div class="page">
  <div class="header">
    <h2>Opção</h2>
    <div class="pill">{{ label }}</div>
    <span class="spacer"></span>
    <a pButton label="Ver todos os pacientes" icon="pi pi-users" [routerLink]="['/pacientes']"></a>
  </div>

  <div class="content">
    <div *ngIf="loading">Carregando pacientes...</div>
    <div *ngIf="error" class="p-text-danger">{{ error }}</div>

    <div *ngIf="!loading && !error" class="controls">
      <label for="paciente">Paciente</label>
      <p-dropdown
        inputId="paciente"
        [options]="pacientes"
        [(ngModel)]="selectedPacienteId"
        optionLabel="fullName"
        optionValue="id"
        placeholder="-- Selecione --"
        [filter]="true"
        filterBy="fullName"
        [showClear]="true"
        [style]="{ width: '100%' }"
        (ngModelChange)="onPacienteChange()">
        <ng-template pTemplate="item" let-option>
          <div>{{ option.fullName }}</div>
        </ng-template>
      </p-dropdown>
    </div>

    <div *ngIf="valuesLoading" class="mt-3">Carregando valores...</div>
    <div *ngIf="valuesError" class="p-text-danger mt-2">{{ valuesError }}</div>

    <div *ngIf="values && values.items && values.items.length" class="mt-3">
      <h3 class="section-title">Valores de {{ label }} para o paciente selecionado</h3>
      <ul class="items">
        <li *ngFor="let it of values.items">
          <div class="item-row">
            <div class="date"><strong>{{ it.attendedAt | date:'dd/MM/yyyy HH:mm' }}</strong></div>
            <div class="value">
              <div class="value-box" [innerHTML]="(it.value && it.value.trim().length) ? it.value : ('<p>Nesse dia não houve ' + label.toLowerCase() + '.</p>')"></div>
            </div>
            <div class="actions" *ngIf="!isEmpty(it.value)">
              <button pButton type="button" class="p-button-rounded p-button-outlined" icon="pi pi-file-pdf" label="PDF" (click)="abrirModalComHtml(it.value!, label)"></button>
              <div style="height:.5rem"></div>
              <a pButton type="button" class="p-button-rounded p-button-secondary" icon="pi pi-external-link" [attr.aria-label]="'Abrir atendimento'" [routerLink]="['/atendimentos', it.attendanceId]"></a>
            </div>
          </div>
        </li>
      </ul>
    </div>

    <div *ngIf="values && (!values.items || !values.items.length) && selectedPacienteId" class="mt-3">
      <em>Nenhum valor encontrado para este campo.</em>
    </div>
  </div>
</div>

<p-dialog [(visible)]="showDialog" [modal]="true" [dismissableMask]="true" [style]="{ width: '800px', maxWidth: '96vw' }" [contentStyle]="{ padding: '0' }" [breakpoints]="{ '960px': '95vw', '640px': '98vw' }">
  <ng-template pTemplate="header">
    <div style="display:flex; align-items:center; width:100%; gap:.75rem;">
      <h3 style="margin:0; font-size:1.1rem;">{{ modalTitle }}</h3>
      <span style="flex:1"></span>
      <button pButton type="button" icon="pi pi-file-pdf" label="Gerar PDF" (click)="gerarPdfDoModal()"></button>
    </div>
  </ng-template>

  <div style="padding:1rem; overflow:auto; max-height:70vh; background:#fff;">
    <div #modalDocContainer [innerHTML]="modalHtml" style="background:#fff;"></div>
  </div>
</p-dialog>
