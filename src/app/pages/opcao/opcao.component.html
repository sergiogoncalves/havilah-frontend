<div class="opcao-page">
  <div class="opcao-container">
    <!-- Header -->
    <div class="page-header">
      <div class="title">
        <h1>{{ label }}</h1>
        <p>Selecione um paciente para consultar os registros deste campo</p>
      </div>

      <div class="header-actions">
        <div class="pill" aria-label="Tipo de opção">{{ label }}</div>
        <a pButton label="Ver pacientes" icon="pi pi-users" class="p-button-outlined" [routerLink]="['/pacientes']"></a>
      </div>
    </div>

    <!-- Seleção de paciente -->
    <section class="patient-card">
      <div class="card-title">
        <div class="icon"><i class="pi pi-user"></i></div>
        <div>
          <h2>Paciente</h2>
          <p>Escolha um paciente para carregar os valores</p>
        </div>
      </div>

      <div *ngIf="loading" class="state-message">
        Carregando pacientes...
      </div>
      <div *ngIf="error" class="state-message state-error">{{ error }}</div>

      <div *ngIf="!loading && !error" class="controls">
        <p-dropdown
          inputId="paciente"
          [options]="pacientes"
          [(ngModel)]="selectedPacienteId"
          optionLabel="fullName"
          optionValue="id"
          placeholder="-- Selecione --"
          [filter]="true"
          filterBy="fullName"
          [showClear]="true"
          [style]="{ width: '100%' }"
          [styleClass]="'w-full'"
          (ngModelChange)="onPacienteChange()">
          <ng-template pTemplate="item" let-option>
            <div>{{ option.fullName }}</div>
          </ng-template>
        </p-dropdown>
      </div>
    </section>

    <!-- Valores -->
    <section class="values-section" *ngIf="selectedPacienteId">
      <div *ngIf="valuesLoading" class="state-message">Carregando valores...</div>
      <div *ngIf="valuesError" class="state-message state-error">{{ valuesError }}</div>

      <div *ngIf="values && values.items && values.items.length" class="values-list">
        <h2 class="section-title">Valores de {{ label }} para o paciente selecionado</h2>

        <ul class="items">
          <li *ngFor="let it of values.items" class="item-card">
            <div class="item-header">
              <div class="date">
                <strong>{{ it.attendedAt | date:'dd/MM/yyyy HH:mm' }}</strong>
              </div>

              <div class="actions" *ngIf="!isEmpty(it.value)">
                <button
                  *ngIf="canShowPdfButton()"
                  pButton
                  type="button"
                  class="p-button-rounded p-button-outlined"
                  icon="pi pi-file-pdf"
                  [attr.aria-label]="'PDF'"
                  (click)="abrirPdfBackend(it.attendanceId)">
                </button>

                <a
                  pButton
                  type="button"
                  class="p-button-rounded p-button-secondary"
                  icon="pi pi-external-link"
                  [attr.aria-label]="'Abrir atendimento'"
                  [routerLink]="['/atendimentos', it.attendanceId]">
                </a>
              </div>
            </div>

            <div class="value-box">
              <div class="ql-container ql-snow">
                <div
                  class="ql-editor"
                  [innerHTML]="(it.value && it.value.trim().length) ? it.value : ('<p>Nesse dia n\u00e3o houve ' + label.toLowerCase() + '.</p>')">
                </div>
              </div>
            </div>
          </li>
        </ul>
      </div>

      <div *ngIf="values && (!values.items || !values.items.length)" class="state-message">
        <em>Nenhum valor encontrado para este campo.</em>
      </div>
    </section>
  </div>
</div>

<!-- Preview fullscreen do PDF vindo do backend (apenas enum) -->
<p-dialog
  [(visible)]="showPdfPreviewDialog"
  [modal]="true"
  [dismissableMask]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '100vw', height: '100vh', maxWidth: '100vw', maxHeight: '100vh' }"
  [contentStyle]="{ padding: '0', height: 'calc(100vh - 4rem)' }"
  (onHide)="onHidePdfPreview()">

  <ng-template pTemplate="header">
    <div style="display:flex; align-items:center; width:100%; gap:.75rem;">
      <h3 style="margin:0; font-size:1.1rem;">{{ pdfPreviewTitle }}</h3>
      <span style="flex:1"></span>
      <button pButton type="button" icon="pi pi-download" class="p-button-text" label="Baixar" (click)="baixarPdfPreview()" [disabled]="!pdfObjectUrl"></button>
      <button pButton type="button" icon="pi pi-times" class="p-button-text" label="Fechar" (click)="onHidePdfPreview()"></button>
    </div>
  </ng-template>

  <div style="height:100%; width:100%;">
    <ng-container *ngIf="pdfSafeUrl; else noPdf">
      <iframe
        [src]="pdfSafeUrl"
        style="border:0; width:100%; height:100%;"
        title="PDF Preview">
      </iframe>
    </ng-container>
    <ng-template #noPdf>
      <div style="padding:1rem;">Carregando...</div>
    </ng-template>
  </div>
</p-dialog>
