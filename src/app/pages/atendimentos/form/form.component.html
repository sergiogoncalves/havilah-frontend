<div class="atendimentos-page">
  <form #atForm="ngForm" class="atendimento-form">

    <!-- Barra sticky (topo centralizado) -->
    <div class="actions-bar" *ngIf="!loading">
      <button
        pButton
        type="button"
        label="Salvar"
        icon="pi pi-check"
        class="p-button-success"
        (click)="save(atForm)"
        [disabled]="saving">
      </button>

      <button
        pButton
        type="button"
        label="Novo"
        icon="pi pi-plus"
        class="p-button-info"
        (click)="newRecord(atForm)"
        [disabled]="saving">
      </button>

      <button
        pButton
        type="button"
        label="Voltar"
        icon="pi pi-arrow-left"
        class="p-button-secondary"
        (click)="back(atForm)">
      </button>
    </div>

    <!-- Conteúdo rolável -->
    <div class="form-scroll">

      <div *ngIf="loading && !atendimento">Carregando...</div>
      <div *ngIf="error" class="p-text-danger">{{ error }}</div>

      <ng-container *ngIf="atendimento">
        <div *ngIf="!pacientesLoaded" class="p-text-info">Carregando pacientes...</div>
        <div *ngIf="pacientesLoaded && pacientes.length === 0" class="p-text-warning">Nenhum paciente disponível.</div>

        <!-- Paciente -->
        <div class="form-field">
          <label>Paciente </label>

          <p-dropdown
            #patientDropdown
            name="patientId"
            [(ngModel)]="atendimento.patientId"
            [options]="pacientes"
            optionLabel="fullName"
            optionValue="id"
            placeholder="-- selecione --"
            [filter]="true"
            filterBy="fullName"
            [showClear]="true"
            [disabled]="isEditMode"
            [style]="{ width: '100%' }"
            [styleClass]="'w-full'"
            [virtualScroll]="pacientes.length > 10"
            (onShow)="onDropdownShow()"
            (onHide)="onDropdownHide()">
          </p-dropdown>

          <div *ngIf="atForm.submitted && isPatientInvalid()" class="p-text-danger">
            Paciente é obrigatório.
          </div>

          <small *ngIf="isEditMode" class="hint">
            O paciente não pode ser alterado durante a edição.
          </small>
        </div>

        <!-- Atendido em -->
        <div class="form-field">
          <label>Atendido em</label>
          <p-calendar
            name="attendedAtLocal"
            [(ngModel)]="attendedAtLocal"
            [showTime]="true"
            hourFormat="24"
            [touchUI]="true"
            dateFormat="dd/mm/yy"
            [style]="{ width: '100%' }"
            [styleClass]="'w-full'">
          </p-calendar>
        </div>

        <!-- Novo campo: Retornar contato (LocalDate) -->
        <div class="form-field">
          <label>Retornar contato</label>
          <p-calendar
            name="retornarContatoLocal"
            [(ngModel)]="retornarContatoLocal"
            [showTime]="false"
            [touchUI]="true"
            dateFormat="dd/mm/yy"
            [style]="{ width: '100%' }"
            [styleClass]="'w-full'">
          </p-calendar>
          <small class="hint">Selecione uma data para retorno de contato (sem horário).</small>
        </div>

        <!-- Editor -->
        <div class="form-field form-editor">
          <label>Descrição Subjetiva - Relato do Paciente</label>
          <quill-editor
            name="relatoPaciente"
            [(ngModel)]="atendimento.descricaoSubjetiva"
            [modules]="quillModules"
            placeholder="Digite...">
          </quill-editor>
        </div>

        <div class="form-field form-editor">
          <label>Objetivo do paciente</label>
          <quill-editor
            name="objetivoPaciente"
            [(ngModel)]="atendimento.objetivoPaciente"
            [modules]="quillModules"
            placeholder="Digite...">
          </quill-editor>
        </div>

        <div class="form-field form-editor">
          <label>Plano Terapêutico</label>
          <quill-editor
            name="planoTerapeutico"
            [(ngModel)]="atendimento.planoTerapeutico"
            [modules]="quillModules"
            placeholder="Digite...">
          </quill-editor>
        </div>

        <div class="form-field form-editor">
          <label>Anotações de enfermagem</label>
          <quill-editor
            name="anotacoesMedicas"
            [(ngModel)]="atendimento.anotacoesMedicas"
            [modules]="quillModules"
            placeholder="Digite...">
          </quill-editor>
        </div>

        <div class="form-field form-editor">
          <label>Terapia Realizada</label>
          <quill-editor
            name="terapiaRealizada"
            [(ngModel)]="atendimento.terapiaRealizada"
            [modules]="quillModules"
            placeholder="Digite...">
          </quill-editor>
        </div>

        <div class="form-field form-editor">
          <label>Orçamento</label>
          <quill-editor
            name="orcamento"
            [(ngModel)]="atendimento.orcamento"
            [modules]="quillModules"
            placeholder="Digite...">
          </quill-editor>
        </div>

        <!-- Novo campo Receita -->
        <div class="form-field form-editor">
          <label>Receita</label>
          <quill-editor
            name="receita"
            [(ngModel)]="atendimento.receita"
            [modules]="quillModules"
            placeholder="Digite...">
          </quill-editor>
        </div>

      </ng-container>
    </div>
  </form>

  <!-- Dialogo de confirmação global para esta página -->
  <p-confirmDialog></p-confirmDialog>
</div>
