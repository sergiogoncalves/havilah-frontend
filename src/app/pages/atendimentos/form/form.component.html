<div class="atendimentos-page">
  <form #atForm="ngForm" class="atendimento-form">

    <div class="form-scroll">
      <div *ngIf="loading && !atendimento">Carregando...</div>
      <div *ngIf="error" class="p-text-danger">{{ error }}</div>

      <ng-container *ngIf="atendimento">
        <div *ngIf="!pacientesLoaded" class="p-text-info">Carregando pacientes...</div>
        <div *ngIf="pacientesLoaded && pacientes.length === 0" class="p-text-warning">Nenhum paciente disponível.</div>

        <!-- Header / Resumo -->
        <div class="page-header">
          <div class="title">
            <h1>Registro de Atendimento</h1>
            <p>Preencha os campos para documentar o atendimento</p>
          </div>

          <div class="header-card">
            <div class="avatar" aria-hidden="true">
              {{ (atendimento.patient?.fullName || '').slice(0, 1) || 'P' }}
            </div>

            <div class="header-fields">
              <div class="header-field">
                <i class="pi pi-user"></i>
                <p-dropdown
                  #patientDropdown
                  name="patientId"
                  [(ngModel)]="atendimento.patientId"
                  [options]="pacientes"
                  optionLabel="fullName"
                  optionValue="id"
                  placeholder="Selecione o paciente"
                  [filter]="true"
                  filterBy="fullName"
                  [showClear]="true"
                  [disabled]="isEditMode"
                  [style]="{ width: '100%' }"
                  [styleClass]="'w-full'"
                  [virtualScroll]="pacientes.length > 10"
                  (onShow)="onDropdownShow()"
                  (onHide)="onDropdownHide()">
                </p-dropdown>
              </div>

              <div class="header-field">
                <i class="pi pi-calendar"></i>
                <p-calendar
                  name="attendedAtLocal"
                  [(ngModel)]="attendedAtLocal"
                  [showTime]="true"
                  hourFormat="24"
                  [touchUI]="true"
                  dateFormat="dd/mm/yy"
                  [style]="{ width: '100%' }"
                  [styleClass]="'w-full'">
                </p-calendar>
              </div>

              <!-- Retornar contato (data sem horário) -->
              <div class="header-field">
                <i class="pi pi-replay"></i>
                <p-calendar
                  name="retornarContatoLocal"
                  [(ngModel)]="retornarContatoLocal"
                  [showTime]="false"
                  [touchUI]="true"
                  dateFormat="dd/mm/yy"
                  placeholder="Retornar contato"
                  [style]="{ width: '100%' }"
                  [styleClass]="'w-full'">
                </p-calendar>
              </div>
            </div>
          </div>

          <div *ngIf="atForm.submitted && isPatientInvalid()" class="p-text-danger">
            Paciente é obrigatório.
          </div>
          <small *ngIf="isEditMode" class="hint">
            O paciente não pode ser alterado durante a edição.
          </small>
        </div>

        <!-- Steps -->
        <div class="steps-card">
          <p-steps [model]="steps" [activeIndex]="activeStepIndex" [readonly]="false"></p-steps>
        </div>

        <!-- Conteúdo das etapas -->
        <div class="step-content">
          <!-- 1: Subjetivo -->
          <section *ngIf="activeStepIndex === 0" class="step-panel">
            <div class="step-title">
              <div class="icon"><i class="pi pi-file"></i></div>
              <div>
                <h2>Descrição Subjetiva</h2>
                <p>Registre as queixas e sintomas relatados pelo paciente</p>
              </div>
            </div>

            <quill-editor
              name="relatoPaciente"
              [(ngModel)]="atendimento.descricaoSubjetiva"
              [modules]="quillModules"
              placeholder="Descreva as queixas principais do paciente, sintomas relatados, histórico relevante...">
            </quill-editor>
          </section>

          <!-- 2: Objetivo -->
          <section *ngIf="activeStepIndex === 1" class="step-panel">
            <div class="step-title">
              <div class="icon"><i class="pi pi-bullseye"></i></div>
              <div>
                <h2>Objetivo do paciente</h2>
                <p>O que o paciente espera alcançar?</p>
              </div>
            </div>

            <quill-editor
              name="objetivoPaciente"
              [(ngModel)]="atendimento.objetivoPaciente"
              [modules]="quillModules"
              placeholder="O objetivo do paciente é...">
            </quill-editor>
          </section>

          <!-- 3: Anotações de enfermagem -->
          <section *ngIf="activeStepIndex === 2" class="step-panel">
            <div class="step-title">
              <div class="icon"><i class="pi pi-notes"></i></div>
              <div>
                <h2>Anotações de enfermagem</h2>
                <p>Registre observações, sinais, orientações e intercorrências</p>
              </div>
            </div>

            <quill-editor
              name="anotacoesMedicas"
              [(ngModel)]="atendimento.anotacoesMedicas"
              [modules]="quillModules"
              placeholder="Ex.: sinais vitais, orientações dadas, cuidados realizados, intercorrências...">
            </quill-editor>
          </section>

          <!-- 4: Plano -->
          <section *ngIf="activeStepIndex === 3" class="step-panel">
            <div class="step-title step-title-row">
              <div class="left">
                <div class="icon"><i class="pi pi-clipboard"></i></div>
                <div>
                  <h2>Plano terapêutico</h2>
                  <p>Conduta, intervenções e recomendações</p>
                </div>
              </div>
              <button pButton type="button" class="p-button-text" icon="pi pi-file-pdf" label="PDF" (click)="abrirDocumentoComCampo('planoTerapeutico', 'Plano terapêutico')"></button>
            </div>

            <quill-editor
              name="planoTerapeutico"
              [(ngModel)]="atendimento.planoTerapeutico"
              [modules]="quillModules"
              placeholder="Defina o plano terapêutico...">
            </quill-editor>
          </section>

          <!-- 5: Orçamento -->
          <section *ngIf="activeStepIndex === 4" class="step-panel">
            <div class="step-title step-title-row">
              <div class="left">
                <div class="icon"><i class="pi pi-wallet"></i></div>
                <div>
                  <h2>Orçamento</h2>
                  <p>Valores, itens e condições</p>
                </div>
              </div>
              <button pButton type="button" class="p-button-text" icon="pi pi-file-pdf" label="PDF" (click)="abrirDocumentoComCampo('orcamento', 'Orçamento')"></button>
            </div>

            <quill-editor
              name="orcamento"
              [(ngModel)]="atendimento.orcamento"
              [modules]="quillModules"
              placeholder="Detalhe o orçamento...">
            </quill-editor>
          </section>

          <!-- 6: Receita -->
          <section *ngIf="activeStepIndex === 5" class="step-panel">
            <div class="step-title step-title-row">
              <div class="left">
                <div class="icon"><i class="pi pi-file-edit"></i></div>
                <div>
                  <h2>Receita</h2>
                  <p>Prescrição e orientações</p>
                </div>
              </div>
              <button pButton type="button" class="p-button-text" icon="pi pi-file-pdf" label="PDF" (click)="abrirDocumentoComCampo('receita', 'Receita')"></button>
            </div>

            <quill-editor
              name="receita"
              [(ngModel)]="atendimento.receita"
              [modules]="quillModules"
              placeholder="Digite a receita...">
            </quill-editor>
          </section>
        </div>
      </ng-container>
    </div>

    <!-- Barra inferior (ações do wizard) -->
    <div class="wizard-actions" *ngIf="!loading">
      <button
        pButton
        type="button"
        label="Anterior"
        icon="pi pi-angle-left"
        class="p-button-outlined"
        (click)="prevStep()"
        [disabled]="isFirstStep()">
      </button>

      <div class="spacer"></div>

      <button
        pButton
        type="button"
        label="Salvar Rascunho"
        icon="pi pi-save"
        class="p-button-outlined"
        (click)="saveDraft(atForm)"
        [disabled]="saving">
      </button>

      <button
        pButton
        type="button"
        [label]="isLastStep() ? 'Salvar' : 'Próximo'"
        [icon]="isLastStep() ? 'pi pi-check' : 'pi pi-angle-right'"
        class="p-button-primary"
        (click)="isLastStep() ? saveFinal(atForm) : nextStep()"
        [disabled]="saving">
      </button>
    </div>
  </form>

  <!-- Dialogo de confirmação global para esta página -->
  <p-confirmDialog></p-confirmDialog>

  <!-- Dialogo para exibição de conteúdo e geração de PDF -->
  <p-dialog [(visible)]="showDialog" [modal]="true" [dismissableMask]="true" [style]="{ width: '800px', maxWidth: '96vw' }" [contentStyle]="{ padding: '0' }">
    <ng-template pTemplate="header">
      <div style="display:flex; align-items:center; width:100%; gap:.75rem;">
        <h3 style="margin:0; font-size:1.1rem;">{{ modalTitle }}</h3>
        <span style="flex:1"></span>
        <button pButton type="button" icon="pi pi-file-pdf" (click)="gerarPdfDoModal()"></button>
      </div>
    </ng-template>

    <div style="padding:1rem; overflow:auto; max-height:70vh; background:#fff;">
      <div #modalDocContainer class="ql-container ql-snow" style="background:#fff;">
        <div class="ql-editor" [innerHTML]="modalHtml"></div>
      </div>
    </div>
  </p-dialog>
</div>
