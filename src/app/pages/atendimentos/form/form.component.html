<div class="atendimentos-page">
  <form #atForm="ngForm" class="atendimento-form">

    <!-- Barra sticky (topo centralizado) -->
    <div class="actions-bar" *ngIf="!loading">
      <button
        pButton
        type="button"
        label="Salvar"
        icon="pi pi-check"
        class="p-button-success"
        (click)="save(atForm)"
        [disabled]="saving">
      </button>

      <button
        pButton
        type="button"
        label="Novo"
        icon="pi pi-plus"
        class="p-button-info"
        (click)="newRecord(atForm)"
        [disabled]="saving">
      </button>

      <button
        pButton
        type="button"
        label="Voltar"
        icon="pi pi-arrow-left"
        class="p-button-secondary"
        (click)="back(atForm)">
      </button>
    </div>

    <!-- Conteúdo rolável -->
    <div class="form-scroll">

      <div *ngIf="loading && !atendimento">Carregando...</div>
      <div *ngIf="error" class="p-text-danger">{{ error }}</div>

      <ng-container *ngIf="atendimento">
        <div *ngIf="!pacientesLoaded" class="p-text-info">Carregando pacientes...</div>
        <div *ngIf="pacientesLoaded && pacientes.length === 0" class="p-text-warning">Nenhum paciente disponível.</div>

        <!-- Paciente -->
        <div class="form-field">
          <label>Paciente </label>

          <p-dropdown
            #patientDropdown
            name="patientId"
            [(ngModel)]="atendimento.patientId"
            [options]="pacientes"
            optionLabel="fullName"
            optionValue="id"
            placeholder="-- selecione --"
            [filter]="true"
            filterBy="fullName"
            [showClear]="true"
            [disabled]="isEditMode"
            [style]="{ width: '100%' }"
            [styleClass]="'w-full'"
            [virtualScroll]="pacientes.length > 10"
            (onShow)="onDropdownShow()"
            (onHide)="onDropdownHide()">
          </p-dropdown>

          <div *ngIf="atForm.submitted && isPatientInvalid()" class="p-text-danger">
            Paciente é obrigatório.
          </div>

          <small *ngIf="isEditMode" class="hint">
            O paciente não pode ser alterado durante a edição.
          </small>
        </div>

        <!-- Atendido em -->
        <div class="form-field">
          <label>Atendido em</label>
          <p-calendar
            name="attendedAtLocal"
            [(ngModel)]="attendedAtLocal"
            [showTime]="true"
            hourFormat="24"
            [touchUI]="true"
            dateFormat="dd/mm/yy"
            [style]="{ width: '100%' }"
            [styleClass]="'w-full'">
          </p-calendar>
        </div>

        <!-- Novo campo: Retornar contato (LocalDate) -->
        <div class="form-field">
          <label>Retornar contato</label>
          <p-calendar
            name="retornarContatoLocal"
            [(ngModel)]="retornarContatoLocal"
            [showTime]="false"
            [touchUI]="true"
            dateFormat="dd/mm/yy"
            [style]="{ width: '100%' }"
            [styleClass]="'w-full'">
          </p-calendar>
          <small class="hint">Selecione uma data para retorno de contato (sem horário).</small>
        </div>

        <!-- Editor -->
        <div class="form-field form-editor">
          <label>Descrição Subjetiva - Relato do Paciente</label>
          <quill-editor
            name="relatoPaciente"
            [(ngModel)]="atendimento.descricaoSubjetiva"
            [modules]="quillModules"
            placeholder="Digite...">
          </quill-editor>
        </div>

        <div class="form-field form-editor">
          <label>Objetivo do paciente</label>
          <quill-editor
            name="objetivoPaciente"
            [(ngModel)]="atendimento.objetivoPaciente"
            [modules]="quillModules"
            placeholder="Digite...">
          </quill-editor>
        </div>

        <div class="form-field form-editor">
          <div class="field-header">
            <label>Plano Terapêutico</label>
            <button pButton type="button" class="p-button-text" icon="pi pi-file-pdf" label="PDF" (click)="abrirDocumentoComCampo('planoTerapeutico', 'Plano terapêutico')"></button>
          </div>
          <quill-editor
            name="planoTerapeutico"
            [(ngModel)]="atendimento.planoTerapeutico"
            [modules]="quillModules"
            placeholder="Digite...">
          </quill-editor>
        </div>

        <div class="form-field form-editor">
          <div class="field-header">
            <label>Orçamento</label>
            <button pButton type="button" class="p-button-text" icon="pi pi-file-pdf" label="PDF" (click)="abrirDocumentoComCampo('orcamento', 'Orçamento')"></button>
          </div>
          <quill-editor
            name="orcamento"
            [(ngModel)]="atendimento.orcamento"
            [modules]="quillModules"
            placeholder="Digite...">
          </quill-editor>
        </div>

        <!-- Novo campo Receita -->
        <div class="form-field form-editor">
          <div class="field-header">
            <label>Receita</label>
            <button pButton type="button" class="p-button-text" icon="pi pi-file-pdf" label="PDF" (click)="abrirDocumentoComCampo('receita', 'Receita')"></button>
          </div>
          <quill-editor
            name="receita"
            [(ngModel)]="atendimento.receita"
            [modules]="quillModules"
            placeholder="Digite...">
          </quill-editor>
        </div>

      </ng-container>
    </div>
  </form>

  <!-- Dialogo de confirmação global para esta página -->
  <p-confirmDialog></p-confirmDialog>

  <!-- Dialogo para exibição de conteúdo e geração de PDF -->
  <p-dialog [(visible)]="showDialog" [modal]="true" [dismissableMask]="true" [style]="{ width: '800px', maxWidth: '96vw' }" [contentStyle]="{ padding: '0' }">
    <ng-template pTemplate="header">
      <div style="display:flex; align-items:center; width:100%; gap:.75rem;">
        <h3 style="margin:0; font-size:1.1rem;">{{ modalTitle }}</h3>
        <span style="flex:1"></span>
        <button pButton type="button" icon="pi pi-file-pdf" (click)="gerarPdfDoModal()"></button>
      </div>
    </ng-template>

    <div style="padding:1rem; overflow:auto; max-height:70vh; background:#fff;">
      <div #modalDocContainer class="ql-container ql-snow" style="background:#fff;">
        <div class="ql-editor" [innerHTML]="modalHtml"></div>
      </div>
    </div>
  </p-dialog>
</div>
